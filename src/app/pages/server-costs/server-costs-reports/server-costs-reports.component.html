<div class="content w3-padding-large">
  <div class="w3-row">
    <div class="w3-col m9 w3-padding-small">
      <div class="w3-row">
        <div class="w3-col m6 w3-padding-small">
          <mat-card class="mat-elevation-z">
            <mat-card-header class="w3-padding-small">
              <mat-card-title class="app-text-theme-primary">Total Cost</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="w3-row">
                <div class="w3-col m5">
                  <ng-container *ngIf="kpi_data.current_duration_cost === null; else templateCurrentDurationCost">
                    <mat-spinner class="loading-indicator-spinner" diameter="38" strokeWidth="3"></mat-spinner>
                  </ng-container>
                  <ng-template #templateCurrentDurationCost>
                    <div class="app-text-theme-primary app-text-500">
                      {{ kpi_data.currency }} {{ kpi_data.current_duration_cost }}
                    </div>

                    <div class="w3-small">
                      {{ form_filters.get('duration_start').value.format('D MMM, YYYY') }} -
                      {{ form_filters.get('duration_end').value.format('D MMM, YYYY') }}
                    </div>
                  </ng-template>
                </div>
                <div class="w3-col m7">
                  <ng-container *ngIf="kpi_data.previous_duration_cost === null; else templatePreviousDurationCost">
                    <mat-spinner class="loading-indicator-spinner" diameter="38" strokeWidth="3"></mat-spinner>
                  </ng-container>
                  <ng-template #templatePreviousDurationCost>
                    <div class="app-text-theme-accent app-text-500">
                      <ng-container *ngIf="kpi_data.change_percentage !== null; else templateZeroPreviousCost">
                        <span
                          [ngClass]="{
                            'app-text-theme-primary-green': kpi_data.change_percentage > 0,
                            'app-text-theme-warn': kpi_data.change_percentage < 0,
                            'app-text-theme-accent': kpi_data.change_percentage === 0
                          }"
                        >
                          <fa-icon *ngIf="kpi_data.change_percentage > 0" [icon]="['fas', 'arrow-down']"></fa-icon>
                          <fa-icon *ngIf="kpi_data.change_percentage < 0" [icon]="['fas', 'arrow-up']"></fa-icon>
                          <fa-icon *ngIf="kpi_data.change_percentage === 0" [icon]="['fas', 'exchange-alt']"></fa-icon>
                          {{
                            kpi_data.change_percentage < 0
                              ? kpi_data.change_percentage.toString().split('-')[1]
                              : kpi_data.change_percentage
                          }}%
                        </span>
                      </ng-container>

                      <ng-template #templateZeroPreviousCost>
                        <ng-container *ngIf="kpi_data.current_duration_cost !== 0; else templateZeroIncrease">
                          <span class="app-text-theme-warn">
                            <fa-icon [icon]="['fas', 'arrow-up']"></fa-icon>
                            -
                          </span>
                        </ng-container>

                        <ng-template #templateZeroIncrease>
                          <span class="app-text-theme-accent">
                            <fa-icon [icon]="['fas', 'exchange-alt']"></fa-icon>
                            -
                          </span>
                        </ng-template>
                      </ng-template>
                    </div>

                    <div class="w3-small">
                      {{ kpi_data.currency }}
                      {{ kpi_data.current_duration_cost - kpi_data.previous_duration_cost }} over
                      {{
                        helper_service
                          .moment(form_filters.get('duration_start').value)
                          .subtract(
                            form_filters
                              .get('duration_end')
                              .value.diff(form_filters.get('duration_start').value, 'days') + 1,
                            'days'
                          )
                          .format('D MMM, YYYY')
                      }}
                      -
                      {{
                        helper_service
                          .moment(form_filters.get('duration_start').value)
                          .subtract(1, 'day')
                          .format('D MMM, YYYY')
                      }}
                    </div>
                  </ng-template>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <div class="w3-col m12 w3-padding-small">
          <mat-card class="mat-elevation-z">
            <mat-card-header class="w3-padding-small">
              <mat-card-title class="app-text-theme-primary">Trends</mat-card-title>
              <mat-card-subtitle class="app-text-theme-accent">
                For duration
                <span class="app-text-500">
                  {{ form_filters.get('duration_start').value.format('D MMM, YYYY') }} -
                  {{ form_filters.get('duration_end').value.format('D MMM, YYYY') }}
                </span>
              </mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="graph-container">
                <ng-container *ngIf="trends_data === null; else templateTrends">
                  <mat-spinner class="loading-indicator-spinner" diameter="60" strokeWidth="3"></mat-spinner>
                </ng-container>
                <ng-template #templateTrends>
                  {{ helper_service.json.stringify(trends_data) }}
                </ng-template>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <div class="w3-col m12 w3-padding-small">
          <mat-card class="mat-elevation-z">
            <mat-card-header class="w3-padding-small">
              <mat-card-title class="app-text-theme-primary">Entries</mat-card-title>
              <mat-card-subtitle class="app-text-theme-accent">
                For duration
                <span class="app-text-500">
                  {{ form_filters.get('duration_start').value.format('D MMM, YYYY') }} -
                  {{ form_filters.get('duration_end').value.format('D MMM, YYYY') }}
                </span>
              </mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="entries-container">
                <ng-container *ngIf="entries_data === null; else templateEntries">
                  <mat-spinner class="loading-indicator-spinner" diameter="60" strokeWidth="3"></mat-spinner>
                </ng-container>
                <ng-template #templateEntries>
                  <ng-container *ngIf="this.form_filters.get('group_by').value === 'product'">
                    <table class="entries-table" mat-table [dataSource]="entries_data">
                      <!-- graph_color_hex Column -->
                      <ng-container matColumnDef="graph_color_hex">
                        <th mat-header-cell *matHeaderCellDef></th>
                        <td mat-cell *matCellDef="let data_row">
                          <fa-icon [icon]="['fas', 'circle']" [style.color]="data_row.graph_color_hex"></fa-icon>
                        </td>
                        <td mat-footer-cell *matFooterCellDef></td>
                      </ng-container>

                      <!-- product Column -->
                      <ng-container matColumnDef="product">
                        <th mat-header-cell *matHeaderCellDef>Product</th>
                        <td mat-cell *matCellDef="let data_row">{{ data_row.product }}</td>
                        <td mat-footer-cell *matFooterCellDef></td>
                      </ng-container>

                      <!-- usage Column -->
                      <!-- <ng-container matColumnDef="usage">
                        <th mat-header-cell *matHeaderCellDef>Usage</th>
                        <td mat-cell *matCellDef="let data_row">
                          {{ human_readable_units_service.format(data_row.usage.amount, data_row.usage.unit) }}
                        </td>
                      </ng-container> -->

                      <!-- cost Column -->
                      <ng-container matColumnDef="cost">
                        <th mat-header-cell *matHeaderCellDef>Amount</th>
                        <td mat-cell *matCellDef="let data_row">
                          {{ data_row.cost.currency }} {{ data_row.cost.amount.toFixed(2) }}
                        </td>
                        <td mat-footer-cell *matFooterCellDef class="w3-right-align app-text-500">
                          Total<br />
                          {{ entries_data[0].cost.currency }} {{ getTotalEntriesCost().toFixed(2) }}
                        </td>
                      </ng-container>

                      <tr mat-header-row *matHeaderRowDef="entries_columns.product; sticky: true"></tr>
                      <tr mat-row *matRowDef="let row; columns: entries_columns.product"></tr>
                      <tr mat-footer-row *matFooterRowDef="entries_columns.product; sticky: true"></tr>
                    </table>
                  </ng-container>
                </ng-template>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </div>

    <div class="w3-col m3 w3-padding-small">
      <mat-card class="mat-elevation-z">
        <mat-card-header class="w3-padding-small">
          <mat-card-title class="app-text-theme-primary">Filters</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <form [formGroup]="form_filters">
            <mat-form-field>
              <mat-label>
                <fa-icon [icon]="['fas', 'arrows-alt-h']"></fa-icon>
                &nbsp;Duration
              </mat-label>
              <mat-select formControlName="duration">
                <mat-option value="current_month">
                  Current month
                </mat-option>
                <mat-option value="last_month">
                  Last month
                </mat-option>
                <mat-divider></mat-divider>
                <mat-option value="last_30_days">
                  Last 30 days
                </mat-option>
                <mat-option value="last_90_days">
                  Last 90 days
                </mat-option>
                <mat-option value="year_to_date">
                  Year to date
                </mat-option>
                <mat-divider></mat-divider>
                <mat-option value="custom">
                  Custom range
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field *ngIf="form_filters.get('duration').value === 'custom'">
              <mat-label>
                <fa-icon [icon]="['fas', 'calendar-day']"></fa-icon>
                &nbsp;From
              </mat-label>
              <input
                matInput
                [matDatepicker]="duration_start_datepicker"
                [max]="form_filters.get('duration_end').value"
                formControlName="duration_start"
              />
              <mat-datepicker-toggle matSuffix [for]="duration_start_datepicker"></mat-datepicker-toggle>
              <mat-datepicker #duration_start_datepicker></mat-datepicker>
              <mat-error *ngIf="form_filters.get('duration_start').hasError('invalidMomentFormat')">
                Date must be of format <b>{{ form_filters.get('duration_start').errors.requiredFormat }}</b
                >.
              </mat-error>
            </mat-form-field>

            <mat-form-field *ngIf="form_filters.get('duration').value === 'custom'">
              <mat-label>
                <fa-icon [icon]="['fas', 'calendar-day']"></fa-icon>
                &nbsp;To
              </mat-label>
              <input
                matInput
                [matDatepicker]="duration_end_datepicker"
                [min]="form_filters.get('duration_start').value"
                formControlName="duration_end"
              />
              <mat-datepicker-toggle matSuffix [for]="duration_end_datepicker"></mat-datepicker-toggle>
              <mat-datepicker #duration_end_datepicker></mat-datepicker>
              <mat-error *ngIf="form_filters.get('duration_end').hasError('invalidMomentFormat')">
                Date must be of format <b>{{ form_filters.get('duration_end').errors.requiredFormat }}</b
                >.
              </mat-error>
            </mat-form-field>

            <mat-divider></mat-divider>

            <mat-form-field class="w3-margin-top">
              <mat-label>
                <fa-icon [icon]="['fas', 'object-group']"></fa-icon>
                &nbsp;Group By
              </mat-label>
              <mat-select formControlName="group_by">
                <mat-option value="product">
                  Product
                </mat-option>
                <mat-option value="sub_product">
                  Sub-product
                </mat-option>
                <mat-divider></mat-divider>
                <mat-option value="no_grouping">
                  No grouping (show total cost only)
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-divider></mat-divider>

            <div class="w3-right-align">
              <button mat-flat-button color="primary" class="w3-margin-top" (click)="setFilters()">
                Apply
              </button>
            </div>
          </form>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
